# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Build & Development Commands

```bash
# Install dependencies
uv install

# Run CLI commands
pilot dashboard          # Interactive TUI dashboard
pilot positions          # View positions (grouped by strategy)
pilot positions --raw    # View positions (ungrouped)
pilot quote SPY          # Get quote for a symbol
pilot analyze            # Run health analysis (LLM-powered)
pilot market             # Market overview

# Linting
ruff check src/
ruff format src/
```

## Architecture Overview

Position Pilot is a CLI/TUI tool for options traders using Tastytrade. Built with Typer (CLI) and Textual (TUI).

**IMPORTANT:** All trading recommendations are now powered by **Claude LLM** (no rule-based fallback).

### Module Structure

```
src/position_pilot/
├── cli.py              # Typer CLI entry point, all commands defined here
├── config.py           # Config file management (~/.config/position-pilot/config.json)
├── client/
│   └── tastytrade.py   # Tastytrade API client (OAuth, positions, quotes, Greeks)
├── models/
│   └── position.py     # Pydantic models: Position, Account, Greeks, Recommendation
├── analysis/
│   ├── strategies.py   # Strategy detection (Iron Condors, Spreads, etc.)
│   ├── llm_signals.py  # LLM-powered position analysis & recommendations (Claude)
│   ├── signals.py      # [DEPRECATED] Legacy rule-based signals (kept for reference)
│   └── market.py       # Market data & IV environment analysis
└── dashboard/
    └── app.py          # Textual TUI dashboard
```

### Key Design Patterns

- **Singleton clients**: `get_client()`, `get_analyzer()`, `get_llm_analyzer()` provide global instances
- **Strategy detection**: `StrategyDetector` groups raw positions into multi-leg strategies (e.g., iron condors from 4 individual options)
- **Reactive UI**: Dashboard uses Textual's reactive properties for automatic updates
- **LLM-first analysis**: All recommendations use Claude; no fallback to rules

### Authentication

Uses OAuth refresh token flow for Tastytrade and API key for Anthropic Claude. Required environment variables:
```
# Tastytrade OAuth
TASTYTRADE_CLIENT_SECRET
TASTYTRADE_REFRESH_TOKEN

# Anthropic Claude API (for LLM-powered recommendations)
ANTHROPIC_API_KEY
```

Get your Anthropic API key from: https://console.anthropic.com/

### Data Flow

1. `TastytradeClient` fetches raw positions from API
2. `enrich_positions_greeks_batch()` adds live Greeks AND underlying prices in batch API calls (with 10-min cache)
3. Option value components calculated per contract:
   - **Intrinsic Value**: Real value (Calls: max(0, Stock - Strike), Puts: max(0, Strike - Stock))
   - **Extrinsic Value**: Time value (Option Price - Intrinsic Value)
4. `detect_strategies()` groups positions into multi-leg strategies
5. `PositionAnalyzer` generates health assessments and recommendations
6. Dashboard/CLI displays results

### Cache Layer

Market data (quotes, Greeks, IV metrics) is cached for 10 minutes:
- **Location**: `~/.cache/position-pilot/`
- **TTL**: 600 seconds (10 minutes)
- **Cache methods**: `get_quote()`, `get_quotes_batch()`, `get_market_metrics()`
- **Bypass cache**: Pass `force_refresh=True` or press `r` in dashboard
- **Clear cache**: `client.clear_cache()`

Positions and account data are NOT cached (always fresh). On app launch, cached market data is used if available, making startup faster.

### LLM-Powered Recommendations

**All trading recommendations are generated by Claude Sonnet 4.5** (no rule-based fallback):

1. **Health Assessment** (`assess_health`)
   - LLM evaluates position health based on Greeks, DTE, P/L, and market context
   - Returns: risk level, issues, opportunities, and status flags
   - Considers: theta decay impact, delta exposure, gamma risk, IV environment

2. **Signal Generation** (`generate_recommendation`)
   - LLM analyzes position + portfolio context + market conditions
   - Returns: signal (HOLD/ROLL/SELL/CLOSE/BUY), urgency (1-5), reasoning
   - Prompts include: full Greeks breakdown, IV rank, distance to strike, portfolio theta/delta

3. **Portfolio Analysis** (`analyze_portfolio`)
   - Generates recommendations for each position using LLM
   - Calculates portfolio-level metrics (total theta, net delta)
   - Sorts by urgency and returns top 5 for dashboard display

**Prompt Engineering:**
- Structured prompts with all relevant position data
- Market context from `market.py` (IV rank, underlying price, distance to strike)
- Explicit instructions for capital preservation over profit maximization
- Considers theta decay, gamma risk, IV exposure, and portfolio correlation

**Error Handling:**
- If LLM fails: returns conservative HOLD signal with error note
- No fallback to rule-based system (by design)
- API timeout: 10 seconds with retry capability

**Cost Optimization:**
- **On-demand recommendations only** - Press 'a' on a strategy row in dashboard
- **Persistent cache** - Recommendations never expire, kept with timestamps
- **User controls** - Generate recommendations when you need them
- **Cache tracking** - See when each recommendation was generated

### Strategy Types Detected

Iron Condors, Iron Butterflies, Verticals (Bull/Bear Call/Put Spreads), Straddles, Strangles, Calendars, Diagonals, Covered Calls, Protective Puts, Collars, Jade Lizards, Butterflies, Synthetic Longs/Shorts, Risk Reversals.

**Synthetic Positions:**
- **Synthetic Long**: Long call + short put at same strike = simulates long stock
- **Synthetic Short**: Short call + long put at same strike = simulates short stock
- **Risk Reversal (Bull)**: Long call + short put at different strikes = bullish directional play
- **Risk Reversal (Bear)**: Short call + long put at different strikes = bearish directional play

Note: These strategies don't require exact quantity matches. If you have +1 call and -2 puts, they will be grouped as a risk reversal (with 1 unit based on the smaller leg).
